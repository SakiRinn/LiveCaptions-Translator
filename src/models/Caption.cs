using System.Windows.Automation;
using System.Text;
using System.ComponentModel;
using System.Runtime.CompilerServices;

using LiveCaptionsTranslator.controllers;

namespace LiveCaptionsTranslator.models
{
    public class Caption : INotifyPropertyChanged
    {
        private static Caption? instance = null;
        public event PropertyChangedEventHandler? PropertyChanged;

        private static readonly char[] PUNC_EOS = ".?!。？！".ToCharArray();
        private static readonly char[] PUNC_COMMA = ",，、—\n".ToCharArray();

        private string displayOriginalCaption = "";
        private string displayTranslatedCaption = "";

        private readonly Queue<CaptionLogItem> captionLog = new(6);
        public class CaptionLogItem
        {
            public string OriginalCaptionLog { get; set; }
            public string TranslatedCaptionLog { get; set; }
        }
        public IEnumerable<CaptionLogItem> CaptionHistory => captionLog.Reverse();
        public static event Action? TranslationLogged;
        public bool TranslateFlag { get; set; } = false;
        public bool EOSFlag { get; set; } = false;
        public bool LogOnlyFlag { get; set; } = false;

        public string OriginalCaption { get; set; } = "";
        public string TranslatedCaption { get; set; } = "";
        public string DisplayOriginalCaption
        {
            get => displayOriginalCaption;
            set
            {
                displayOriginalCaption = value;
                OnPropertyChanged("DisplayOriginalCaption");
            }
        }
        public string DisplayTranslatedCaption
        {
            get => displayTranslatedCaption;
            set
            {
                displayTranslatedCaption = value;
                OnPropertyChanged("DisplayTranslatedCaption");
            }
        }

        private Caption() { }

        public static Caption GetInstance()
        {
            if (instance != null)
                return instance;
            instance = new Caption();
            return instance;
        }

        public void OnPropertyChanged([CallerMemberName] string propName = "")
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propName));
        }

        public void Sync()
        {
            int idleCount = 0;
            int syncCount = 0;
            string originalLatest = "originalLatest";
            string captionLatest = "";

            while (true)
            {
                if (App.Window == null)
                {
                    Thread.Sleep(1000);
                    continue;
                }

                // Is caption textbox change to another sentence
                bool captionTrim = false;
                // Get the text recognized by LiveCaptions.
                string fullText = GetCaptions(App.Window).Trim();
                if (string.IsNullOrEmpty(fullText))
                    continue;
                // Preprocess - Remove redundant `\n`.
                foreach (char eos in PUNC_EOS)
                    fullText = fullText.Replace($"{eos}\n", $"{eos}");

                // Get the last sentence.
                int lastEOSIndex;
                if (Array.IndexOf(PUNC_EOS, fullText[^1]) != -1)
                    lastEOSIndex = fullText[0..^1].LastIndexOfAny(PUNC_EOS);
                else
                    lastEOSIndex = fullText.LastIndexOfAny(PUNC_EOS);
                string latestCaption = fullText.Substring(lastEOSIndex + 1);

                // If the last sentence is too short, extend it by adding the previous sentence.
                while (lastEOSIndex > 0 && Encoding.UTF8.GetByteCount(latestCaption) < 10)
                {
                    captionTrim = true;
                    lastEOSIndex = fullText[0..lastEOSIndex].LastIndexOfAny(PUNC_EOS);
                    latestCaption = fullText.Substring(lastEOSIndex + 1);
                }

                // Replace the excessive `\n` generated by LiveCaptions with `--` to ensure coherence.
                latestCaption = latestCaption.Replace("\n", "——");

                /******************/
                /***   UPDATE   ***/
                /******************/
                if (OriginalCaption.CompareTo(latestCaption) != 0)
                {
                    idleCount = 0;
                    syncCount++;

                    OriginalCaption = latestCaption;
                    // If the last sentence is too long, truncate it when displayed.
                    DisplayOriginalCaption = ShortenDisplaySentence(OriginalCaption);

                    if (Array.IndexOf(PUNC_EOS, OriginalCaption[^1]) != -1)
                    {
                        syncCount = 0;
                        TranslateFlag = true;
                        EOSFlag = true;
                        captionTrim = true;
                    }
                    else
                        EOSFlag = false;

                    if (DisplayOriginalCaption != OriginalCaption)
                        captionTrim = true;

                    // Push current caption to history without waiting for async
                    if (captionTrim)
                    {
                        string oc = captionLatest;
                        string _oc = StringTrim(oc, 3, oc.Length - 3);
                        string _ol = StringTrim(originalLatest, 3, originalLatest.Length - 3);
                        if (_oc != _ol) // Prevent from spamming
                        {
                            originalLatest = oc;
                            var historyTask = Task.Run(() => HistoryCapture(oc));
                        }
                    }
                    else
                        captionLatest = OriginalCaption;
                }
                else
                    idleCount++;

                if (syncCount > App.Settings.MaxSyncInterval ||
                    idleCount == App.Settings.MaxIdleInterval)
                {
                    syncCount = 0;
                    TranslateFlag = true;
                }
                Thread.Sleep(50);
            }
        }

        private string StringTrim(string text, int start, int length)
        {
            try
            {
                return text.Substring(start, length).ToLower();
            }
            catch
            {
                return text.ToLower();
            }
        }

        private async Task HistoryCapture(string original)
        {
            string unixTime = DateTimeOffset.UtcNow.ToUnixTimeSeconds().ToString();
            string translated = "⏸";
            string targetLanguage = App.Settings.TargetLanguage;
            string apiName = App.Settings.ApiName;
            bool captionLog = App.Settings.EnableCaptionLog;

            // Insert history database
            try
            {
                if (LogOnlyFlag) // Log only mode no translate
                {
                    SQLiteHistoryLogger.LogTranslation(unixTime, original, "N/A", "N/A", "LogOnly");
                }
                else
                {
                    translated = await TranslationController.Translate(original);
                    SQLiteHistoryLogger.LogTranslation(unixTime, original, translated, targetLanguage, apiName);
                }
                TranslationLogged?.Invoke();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[Error] Logging history failed: {ex.Message}");
            }

            // Add caption log card
            if (captionLog)
            {
                if (this.captionLog.Count >= 6)
                    this.captionLog.Dequeue();
                this.captionLog.Enqueue(new CaptionLogItem
                {
                    OriginalCaptionLog = original,
                    TranslatedCaptionLog = translated
                });
                OnPropertyChanged(nameof(CaptionHistory));
            }
        }

        public void ClearCaptionLog()
        {
            captionLog.Clear();
            OnPropertyChanged(nameof(CaptionHistory));
        }

        public async Task Translate()
        {
            while (true)
            {
                if (TranslateFlag)
                {
                    // Log Only
                    if (LogOnlyFlag)
                    {
                        // Do not translate
                        TranslatedCaption = string.Empty;
                        DisplayTranslatedCaption = "⏸️";
                    }
                    else
                    {
                        // Translate and display
                        TranslatedCaption = await TranslationController.Translate(OriginalCaption);
                        DisplayTranslatedCaption = ShortenDisplaySentence(TranslatedCaption);
                    }

                    TranslateFlag = false;
                    if (EOSFlag)
                        Thread.Sleep(1000);
                }
                Thread.Sleep(50);
            }
        }

        public static string GetCaptions(AutomationElement window)
        {
            var captionsTextBlock = LiveCaptionsHandler.FindElementByAId(window, "CaptionsTextBlock");
            if (captionsTextBlock == null)
                return string.Empty;
            return captionsTextBlock.Current.Name;
        }

        private static string ShortenDisplaySentence(string displaySentence)
        {
            while (Encoding.UTF8.GetByteCount(displaySentence) >= 160)
            {
                int commaIndex = displaySentence.IndexOfAny(PUNC_COMMA);
                if (commaIndex < 0 || commaIndex + 1 >= displaySentence.Length)
                    break;
                displaySentence = displaySentence.Substring(commaIndex + 1);
            }
            return displaySentence;
        }
    }
}
